import { NextRequest } from 'next/server';
import { promises as fs } from 'fs';
import path from 'path';

const REG_PATH = path.join(process.cwd(), 'cursorapp/src/app/api/tommy/regulation/regulation.json');
const DEFAULT_REG = `Назва: Donetsk1y FC25 league Season 1\nОсновний турнір\nЕтап 1: Швейцарська система\nКількість учасників не обмежена\nУсі матчі ВО1 (один поєдинок)\nНічиїх результатів бути не може\nПроходять 128 гравці з найкращими показниками\nПорядок сортування:\nОчки\nБухгольц \nРізниця м'ячів\nЗабиті м'ячі\nПропущені м'ячі (менше = краще)\nУ випадку рівності всіх показників, додатковий особистий плейраунд\nТі, хто не пройшов, потрапляють до другого турніру автоматично, відміна реєстрації за бажанням\nЕтап 2: Плей-офф\nSingle elimination сітка на 128 гравці\nПосів: сильний-слабий після швейцарки (Формат ЛЧ)\nВсі матчі ВО2\nУ турнірах нічиїх результатів бути не може (граємо 2 матчі і рахуємо різницю голів)\nЯкщо різниця голів рівна, одразу серія пенальті\n1/64, 1/32, 1/16, 1/8, 1/4, 1/2 фіналу, матч за 3-тє місце, фінал\nДругий турнір (для вибулих на першому етапі)\nЕтап 2: Плей-офф\nSingle elimination сітка , автоматична реєстрація після першого етапу\nВсі матчі ВО2, без нічиїх\nУ турнірах нічиїх результатів бути не може (граємо 2 матчі і рахуємо різницю голів)\nЯкщо різниця голів рівна, одразу серія пенальті\n1/128, 1/64, 1/32, 1/16, 1/8, 1/4, 1/2 фіналу, матч за 3-тє місце, фінал\nТехнічні вимоги\nТой, хто грає вдома першим, вимірюється монетою, учасники самі списуються один з одним, та кидають жребій (як приклад кубік в телеграмі), отримати інформацію за суперником можна скопіювавши його дані натисканням на нік в блоці учасників\nНалаштування матчу: Класична товарка, оренди не дозволені, вартість склажу максимум 20кк\nСтадіон UT Champions\nГазон Класичний\nЧасові рамки\nОсновний турнір:\nШвейцарка: 8 днів, час проведення матчів за домовленістю\nякщо домовленості нема, то час проведення матчів з 18-00 до 08-00 наступного ранку\nу випадку не зіграного матчу поразка віддається тому, через кого гра не відбулася. Якщо гра не відбулася через форс-мажор, переможець обирається жеребом через сайт random.org\nПлей-офф: залежить від кількості учасників\nна 1 раунд 1 день\nДругий турнір:\nПлей-офф: залежить від кількості учасників\nна 1 раунд 1 день`;

export async function GET() {
  try {
    const data = await fs.readFile(REG_PATH, 'utf-8');
    const obj = JSON.parse(data);
    return new Response(obj.text, { status: 200 });
  } catch {
    return new Response(DEFAULT_REG, { status: 200 });
  }
}

export async function POST(req: NextRequest) {
  let text = await req.text();
  let obj;
  try {
    obj = JSON.parse(text);
    if (typeof obj.text === 'string') {
      text = obj.text;
    } else {
      obj = null;
    }
  } catch {
    // не JSON, значит просто строка
    obj = null;
  }
  const toSave = { text };
  await fs.writeFile(REG_PATH, JSON.stringify(toSave, null, 2), 'utf-8');
  return new Response('ok', { status: 200 });
} 